Estoy desarrollando con vos un sistema llamado SOMA (Sistema Organizado de MensajerÃ­a y AutomatizaciÃ³n). El sistema estÃ¡ pensado para automatizar mensajes, controlar stock, gestionar ventas y delivery, e incluir IA para responder chats y sugerencias. El backend lo estamos desarrollando en Python con FastAPI y SQLite (por ahora), y luego se podrÃ¡ migrar a PostgreSQL. Vamos trabajando por mÃ³dulos y el primer mÃ³dulo es la base de datos de productos, clientes y pedidos, con sus endpoints REST. El frontend serÃ¡ en Flutter, pero eso viene despuÃ©s. Nuestra lÃ³gica de automatizaciÃ³n incluirÃ¡ reglas simples al principio y luego IA real. No pierdas este contexto aunque se corte la conversaciÃ³n, y mantenÃ© un estilo directo, sin condescendencia, como comandante y socio tÃ©cnico. Si te paso este prompt, seguÃ­ desde donde quedamos o actualizalo si el proyecto avanzÃ³. Comenzamos por el backend bÃ¡sico. No asumas nada que no estÃ© en este prompt salvo que yo lo apruebe.



ğŸ§± PASO 1: DiseÃ±o de modelos de datos (en texto plano)
Para que estemos seguros de que cada tabla (entidad) tiene lo que necesita, sin cÃ³digo todavÃ­a. Lo validamos juntos.

Ejemplo:

text
Copy
Edit
Producto:
- id (int)
- nombre (string)
- stock_actual (int)
- precio_unitario (float)
- unidad (string, ej: kg, unidad, litro)
- creado_en (datetime)
- actualizado_en (datetime)
âš™ï¸ PASO 2: Estructura de proyecto FastAPI
Creo la estructura de carpetas:

pgsql
Copy
Edit
soma/
â”œâ”€â”€ main.py
â”œâ”€â”€ models/
â”œâ”€â”€ schemas/
â”œâ”€â”€ routes/
â”œâ”€â”€ database.py
â””â”€â”€ crud/
ğŸ”Œ PASO 3: Endpoints REST funcionales
Ejemplo:

GET /productos

POST /productos

PUT /productos/{id}

DELETE /productos/{id}

ğŸ§ª PASO 4: Testear vÃ­a Swagger UI
FastAPI ya trae Swagger por defecto, asÃ­ que vamos viendo todo en el navegador.

ğŸ§  PASO 5: Agregar automatizaciÃ³n e IA
Una vez que esto funcione, ahÃ­ sÃ­ conectamos:

WhatsApp

Reglas inteligentes

IA (GPT) para respuestas o predicciones




soma_backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ producto.py
â”‚   â”‚   â”œâ”€â”€ cliente.py
â”‚   â”‚   â”œâ”€â”€ pedido.py
â”‚   â”‚   â”œâ”€â”€ detalle_pedido.py
â”‚   â”‚   â””â”€â”€ mensaje.py
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ producto.py
â”‚   â”‚   â”œâ”€â”€ cliente.py
â”‚   â”‚   â”œâ”€â”€ pedido.py
â”‚   â”‚   â”œâ”€â”€ detalle_pedido.py
â”‚   â”‚   â””â”€â”€ mensaje.py
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ producto.py
â”‚   â”‚   â”œâ”€â”€ cliente.py
â”‚   â”‚   â”œâ”€â”€ pedido.py
â”‚   â”‚   â”œâ”€â”€ detalle_pedido.py
â”‚   â”‚   â””â”€â”€ mensaje.py
â”‚   â”œâ”€â”€ crud/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ producto.py
â”‚   â”‚   â”œâ”€â”€ cliente.py
â”‚   â”‚   â”œâ”€â”€ pedido.py
â”‚   â”‚   â”œâ”€â”€ detalle_pedido.py
â”‚   â”‚   â””â”€â”€ mensaje.py
â”‚   â”œâ”€â”€ database.py

## BitÃ¡cora de IntegraciÃ³n IA - SOMA

### Fecha: 25 de junio de 2025

**Objetivo**: Integrar respuestas automÃ¡ticas utilizando OpenRouter (modelo `deepseek/deepseek-r1:free`) en los mensajes tipo "entrada" en el sistema SOMA.

---

### Cambios Realizados en el CÃ³digo

**Archivo modificado:** `routes/mensajes.py`

#### Comportamiento del endpoint `POST /mensajes/`:

1. Guarda el mensaje recibido como entrada.
2. Si el mensaje es de tipo `"entrada"`, se realiza bÃºsqueda de palabras clave en el contenido.
3. Se comparan las palabras encontradas con los nombres de los productos existentes en la base de datos.
4. Si hay coincidencia:

   * Se genera una respuesta automÃ¡tica llamando a la funciÃ³n `generar_respuesta_ia()`.
   * Se guarda una nueva entrada del tipo `"automatica"` con la respuesta generada.
5. Se devuelve una lista con los mensajes guardados (el original y el generado si corresponde).

### Cambios en `generar_respuesta_ia()` (ubicado en `services/ia.py`):

* Se usa el modelo gratuito `deepseek/deepseek-r1:free` de OpenRouter.
* Se actualizÃ³ la URL del endpoint: `https://openrouter.ai/api/v1/chat/completions`
* Se agregÃ³ manejo de errores con `raise_for_status()`.

### Variables necesarias en `.env`:

```env
OPENROUTER_API_KEY=sk-or-v1-XXXXXX...
```

---

### Resultado Esperado

Cuando se envÃ­a un mensaje del tipo:

```json
{
  "cliente_id": 1,
  "canal": "WhatsApp",
  "contenido": "Â¿CuÃ¡nto cuesta el arroz?",
  "tipo": "entrada"
}
```

Y existe un producto llamado `arroz` en la base de datos, se deberÃ­a guardar tambiÃ©n una respuesta automÃ¡tica como:

```json
{
  "cliente_id": 1,
  "canal": "WhatsApp",
  "contenido": "Hola! Tenemos arroz a 6500 guaranÃ­es. Â¿QuerÃ©s que prepare un pedido para vos?",
  "tipo": "automatica",
  "respuesta_de": <id del mensaje original>
}
```

---

### Estado Actual: âœ… Funcional

El endpoint ya genera y devuelve las respuestas automÃ¡ticas correctamente.

---

**Observaciones:**

* Se recomienda registrar los errores de la IA con logging en lugar de `print()`.
* Se sugiere validar si `producto.nombre.lower()` aparece **como palabra completa** (ya implementado con `re.findall`).
